* Map Tile Styles

#+BEGIN_SRC leisure :results dynamic
buildStyles data = strCat (map (\i . do
  t = tail i
  codes = ((assoc 'codes' t) id '')
  offsetX = ((assoc 'offsetX' t) id 0)
  topPos = ((assoc 'offsetY' t) id 0)
  widthOfCurrent = ((assoc 'width' t) id 0)
  strCat (map (\j . do
    not (strAt codes j) == '_'
    strCat (map (\k . do
      leftPos = offsetX + widthOfCurrent * k
      s[s['.tile-sprite[data-code="' (strAt codes j) k '"] {\n']
      s['  background-position: -' leftPos 'px -' topPos 'px !important;\n']
      s['  height: ' ((assoc 'height' t) id 0) 'px;\n']
      s['  width: ' widthOfCurrent 'px;\n']
      s['}\n']])
      (range 0 4)))
    (range 0 (strLen codes))))
  data)

changeData
  url <- foreach getImage 'tiles/tileset_cave_1.png'
  data <- foreach getData 'tileSets'
  updateTiles (s['.tile-sprite {\n' '  background-image: url(' url ');\n' '  background-repeat: no-repeat;\n' '}\n']) + (buildStyles data)


1
#+END_SRC
#+RESULTS:
: 1


#+TITLE: Test Isometric Tiles
* tests
#+BEGIN_SRC leisure :results dynamic
handleListFuncMacro name numVars expr = do
  vars = take numVars expr
  r = drop numVars expr
  list = head r
  rest = tail r
  print s['vars ' vars]
  print s['list ' list]
  print s['rest ' rest]
  []
  [name ['\\' | (append vars ['.' | (handleDo rest false id)])] list]

defMacro 'doMap' \expr . handleListFuncMacro 'map' 1 expr

simplify 'doMap i [1 2 3 4] (i + 1)'
doMap i [1 2 3 4 5] (i + 1)
#doMap i [1 2 3 4 5]
#  print i
#
#3
#map (\i . (+ i 1)) [1 2 3 4]
#+END_SRC
* Tiles
#+BEGIN_HTML :var map
<div class="map">
 {{#each map}}
   <div class="row {{#if_even @index}} even{{/if_even}}">
     {{#each (stringChunk this 2)}}<div class="tile-sprite iso" data-code="{{this}}" data-coords="{{@index}} {{@../index}}"></div>{{/each}}
   </div>
 {{/each}}
</div>
#+END_HTML

#+BEGIN_SRC coffee :results def
Handlebars.registerHelper 'stringChunk', (string, chunkSize)->
  el.join '' for el in _.chunk(string, chunkSize)
#+END_SRC

#+NAME: map
#+BEGIN_SRC yaml
- a0
- b0
#+END_SRC

#+NAME: tileSets
#+BEGIN_SRC yaml
floor:
  codes: abcdefghijk
  offsetX: 0
  offsetY: 0
  width: 64
  height: 32
walls:
  codes: lmnopq__rstuv
  offsetX: 0
  offsetY: 125
  width: 64
  height: 128
objects:
  codes: wx
  offsetX: 0
  offsetY: 640
  width: 64
  height: 64
rocks:
  codes: yzA
  offsetX: 0
  offsetY: 704
  width: 64
  height: 128
water:
  codes: BCDEFGH
  offsetX: 0
  offsetY: 832
  width: 64
  height: 64
#+END_SRC

#+BEGIN_SRC coffee :results def
Handlebars.registerHelper 'if_even', (conditional, options)->
  if (conditional % 2) == 0 then options.fn(this) else options.inverse(this)
#+END_SRC

#+BEGIN_SRC css
.map {
  margin-top: 3em;
  width: 1024px;
  overflow: hidden;
  padding-top: 32px;
  padding-bottom: 16px;
  white-space: nowrap;
}
.row {
  height: 16px;
}
.even {
  padding-left: 32px;
}
.iso {
  display: inline-block;
  width: 64px;
  height: 32px;
}
#+END_SRC

* Old CoffeeScript for sprites
*changed to defX so it doesn't auto-load*

#+BEGIN_SRC coffee :results defX
  Lounge.data.getFile "tiles/tileset_cave_1.png", (contents)->
    col = 0
    row = 0
    # convert image data to blob because of performance lag from ordinary data url
    # thanks to Dan Bovey
    # http://stackoverflow.com/questions/28744562/chrome-dev-tools-is-being-slow-because-im-using-dataimage-in-background-image
    byteArrays = for offset in [0...contents.length] by 512
      slice = contents.slice offset, offset + 512
      new Uint8Array (slice.charCodeAt(i) for i in [0...512])
    blob = new Blob byteArrays, type: 'image/png'
    str = """
      .tile-sprite {
        background-image: url(#{URL.createObjectURL blob});
        background-repeat: no-repeat;
      }
    """

    for v, k in "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOP"
      str += """
        .tile-sprite[data-letter="#{v}"] {
          background-position: -#{col * 64}px -#{row * 32}px !important;
        }
      """
      col += 1
      if col == 16
        col = 0
        row++
    $('#tile-styles').remove()
    $(document.head).append "<style id='tile-styles'>#{str}</style>"
#+END_SRC

* Leisure code
** Primitives for Leisure
#+BEGIN_SRC coffee :results def
{define, right, left, isPartial, partialCall, Monad2} = Leisure.Runtime

define 'updateTiles', (str)->
  new Monad2 (env, cont)->
    $('#tile-styles').remove()
    $(document.head).append "<style id='tile-styles'>#{resolve str}</style>"
#+END_SRC

#+BEGIN_SRC leisure :results xdef
do
  url <- foreach getImage 'tiles/tileset_cave_1.png'
  codes = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOP"
  updateTiles (s['.tile-sprite {\n' '  background-image: url(' url ');\n' '  background-repeat: no-repeat;\n' '}\n']) + (strCat (map (\i . do
    row = floor (i / 16)
    col = i % 16
    s[s['.tile-sprite[data-letter=' (strAt codes i) '] {\n']
      s['  background-position: -' (col * 64) 'px -' (row * 32) 'px !important;\n']
      '}\n'])
      (range 0 (strLen codes))))
#+END_SRC

#+BEGIN_SRC leisure :results dynamic
buildStyles data = strCat (map (\i . do s[(head i) ' ']) data)

changeData
 data <- foreach getData 'tileSets'
 print (buildStyles data)
 1
#+END_SRC
